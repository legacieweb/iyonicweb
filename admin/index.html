<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Iyonicorp Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .admin-section { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    #adminPopup { transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .user-card:hover .manage-btn { transform: translateY(-2px); }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
  </style>
  <script>
    if (!localStorage.getItem("admin")) {
      window.location.href = "../adminlogin";
    }
  </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

  <!-- Mobile Hamburger -->
  <div class="md:hidden p-4 bg-white text-gray-800 flex justify-between items-center shadow-sm">
    <h1 class="text-xl font-bold text-gray-800">Iyonicorp Admin</h1>
    <button id="toggleMenu" class="text-gray-800 text-xl focus:outline-none">‚ò∞</button>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="bg-gradient-to-br from-slate-900 to-gray-900 text-white w-72 fixed top-0 left-0 h-full flex flex-col p-6 space-y-8 z-40 hidden md:flex shadow-2xl transition-all duration-300">
    <div class="flex items-center space-x-3 px-2">
      <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/30">
        <span class="text-2xl font-black text-white">I</span>
      </div>
      <h1 class="text-xl font-black tracking-tight uppercase text-white">Iyonicorp <span class="text-orange-500">Admin</span></h1>
    </div>
    
    <nav class="flex flex-col space-y-2">
      <button onclick="showAdminSection('overview')" class="flex items-center space-x-3 hover:bg-white/10 px-4 py-3 rounded-xl transition-all duration-200 group">
        <span class="text-lg opacity-70 group-hover:opacity-100">üìä</span>
        <span class="font-medium tracking-wide text-white">Overview</span>
      </button>
      <button onclick="showAdminSection('pipeline')" class="flex items-center space-x-3 hover:bg-white/10 px-4 py-3 rounded-xl transition-all duration-200 group">
        <span class="text-lg opacity-70 group-hover:opacity-100">üöÄ</span>
        <span class="font-medium tracking-wide text-white">Pipeline</span>
      </button>
      <button onclick="showAdminSection('users')" class="flex items-center space-x-3 hover:bg-white/10 px-4 py-3 rounded-xl transition-all duration-200 group">
        <span class="text-lg opacity-70 group-hover:opacity-100">üë•</span>
        <span class="font-medium tracking-wide text-white">Users</span>
      </button>
    </nav>

    <div class="mt-auto space-y-4">
      <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
        <p class="text-xs text-gray-400 mb-1">Signed in as</p>
        <p class="text-sm font-bold truncate text-white">Admin Manager</p>
      </div>
      <button onclick="logout()" class="w-full bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white px-4 py-3 rounded-xl font-bold transition-all duration-200 flex items-center justify-center space-x-2">
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="md:ml-72 p-8 space-y-12 bg-gray-50 min-h-screen transition-all duration-300">

    <!-- Overview -->
    <section id="overviewSection" class="admin-section">
      <div class="mb-10">
        <h2 class="text-4xl font-black text-gray-900 tracking-tight">Platform Insights</h2>
        <p class="text-gray-500 mt-2 font-medium">Real-time performance and user metrics</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group card-hover">
          <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
          </div>
          <h3 class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-2">Total Users</h3>
          <p class="text-4xl font-black text-gray-900" id="totalUsers">...</p>
        </div>

        <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group card-hover">
          <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
          </div>
          <h3 class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-2">Active Sites</h3>
          <p class="text-4xl font-black text-gray-900" id="activeSites">...</p>
        </div>

        <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group card-hover">
          <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          </div>
          <h3 class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-2">Total Revenue</h3>
          <p class="text-4xl font-black text-emerald-600" id="totalRevenue">$...</p>
        </div>
      </div>
    </section>

    <!-- Pipeline Section -->
    <section id="pipelineSection" class="admin-section hidden">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-6">
        <div>
          <h2 class="text-4xl font-black text-gray-900 tracking-tight">Business Pipeline</h2>
          <p class="text-gray-500 mt-2 font-medium">Manage and track your sales leads</p>
        </div>
        <button onclick="openPipelineModal()" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-4 rounded-2xl font-black transition-all duration-200 shadow-xl shadow-blue-600/20 hover:scale-105 active:scale-95">
          + New Prospect
        </button>
      </div>

      <div class="mb-6">
        <div class="flex flex-wrap gap-2 mb-4" id="statusFilters">
          <!-- Status filter buttons will be injected here -->
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="pipelineTiles">
        <!-- Pipeline tiles will be injected here -->
      </div>
    </section>

    <!-- Users -->
    <section id="usersSection" class="admin-section hidden">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-8">
        <h2 class="text-3xl font-extrabold text-gray-800">üë• User Management</h2>
        <div class="relative w-full md:w-96">
          <input
            type="text"
            id="userSearchInput"
            oninput="filterUsers()"
            placeholder="Search by name or email..."
            class="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all duration-200"
          />
          <svg class="w-5 h-5 text-gray-400 absolute left-4 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
      </div>
      <div id="usersTable" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <div class="col-span-full text-center py-20 text-gray-500">Loading users...</div>
      </div>      
    </section>

<!-- Admin Popup -->
<div id="adminPopup" class="fixed top-8 right-8 z-[100] hidden transform translate-x-full transition-all duration-500">
  <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-4 flex items-center space-x-3 min-w-[280px]">
    <div id="adminPopupIcon" class="w-8 h-8 rounded-lg flex items-center justify-center text-lg"></div>
    <div>
      <h4 id="adminPopupTitle" class="font-bold text-sm text-gray-800"></h4>
      <p id="adminPopupText" class="text-gray-600 text-sm"></p>
    </div>
  </div>
</div>

<!-- Pipeline Modal -->
<div id="pipelineModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
  <div id="modalContainer" class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-2xl transform scale-95 transition-all duration-300">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">Add New Prospect</h3>
        <p class="text-gray-500 mt-1">Fill in the lead details below</p>
      </div>
      <button onclick="closePipelineModal()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors duration-200">
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    
    <form id="pipelineForm" class="space-y-4">
      <input type="hidden" id="pipelineId" />
      
      <div class="grid grid-cols-1 gap-4">
        <div class="space-y-1">
          <label class="text-sm font-medium text-gray-700">Business Name</label>
          <input type="text" id="businessName" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-900 placeholder-gray-400 transition-all duration-200" placeholder="Enter name..." />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-1">
          <label class="text-sm font-medium text-gray-700">Email Address</label>
          <input type="email" id="email" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-900 placeholder-gray-400 transition-all duration-200" placeholder="email@example.com" />
        </div>
        <div class="space-y-1">
          <label class="text-sm font-medium text-gray-700">Phone Number</label>
          <input type="text" id="phone" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-900 placeholder-gray-400 transition-all duration-200" placeholder="+1..." />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-1">
          <label class="text-sm font-medium text-gray-700">Secondary Phone</label>
          <input type="text" id="secondaryPhone" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-900 placeholder-gray-400 transition-all duration-200" placeholder="Alternative phone..." />
        </div>
        <div class="space-y-1">
          <label class="text-sm font-medium text-gray-700">Alt Contact / Name</label>
          <input type="text" id="altContact" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-900 placeholder-gray-400 transition-all duration-200" placeholder="Assistant, partner, etc..." />
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Prospect Status</label>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
          <label class="cursor-pointer">
            <input type="radio" name="status-radio" value="Lead" class="hidden peer" checked onchange="document.getElementById('status').value=this.value">
            <div class="p-3 text-center rounded-lg bg-gray-50 text-sm font-medium text-gray-600 peer-checked:bg-blue-600 peer-checked:text-white transition-all duration-200">Lead</div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="status-radio" value="Contacted" class="hidden peer" onchange="document.getElementById('status').value=this.value">
            <div class="p-3 text-center rounded-lg bg-gray-50 text-sm font-medium text-gray-600 peer-checked:bg-blue-600 peer-checked:text-white transition-all duration-200">Contacted</div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="status-radio" value="Proposal" class="hidden peer" onchange="document.getElementById('status').value=this.value">
            <div class="p-3 text-center rounded-lg bg-gray-50 text-sm font-medium text-gray-600 peer-checked:bg-blue-600 peer-checked:text-white transition-all duration-200">Proposal</div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="status-radio" value="In Progress" class="hidden peer" onchange="document.getElementById('status').value=this.value">
            <div class="p-3 text-center rounded-lg bg-gray-50 text-sm font-medium text-gray-600 peer-checked:bg-blue-600 peer-checked:text-white transition-all duration-200">In Progress</div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="status-radio" value="Completed" class="hidden peer" onchange="document.getElementById('status').value=this.value">
            <div class="p-3 text-center rounded-lg bg-gray-50 text-sm font-medium text-gray-600 peer-checked:bg-blue-600 peer-checked:text-white transition-all duration-200">Completed</div>
          </label>
        </div>
        <input type="hidden" id="status" value="Lead" />
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Additional Notes</label>
        <textarea id="notes" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-900 placeholder-gray-400 transition-all duration-200 h-24 resize-none" placeholder="Enter notes..."></textarea>
      </div>

      <div class="flex flex-col sm:flex-row items-center gap-4 pt-4">
        <button type="button" onclick="closePipelineModal()" class="w-full sm:w-auto flex-1 py-3 px-6 text-sm font-medium text-gray-600 hover:text-gray-900 border border-gray-200 rounded-lg transition-colors duration-200">Discard</button>
        <button type="submit" class="w-full sm:w-auto flex-[2] bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white py-3 px-6 rounded-lg font-medium shadow-xl shadow-blue-600/20 transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]">Save Prospect</button>
      </div>
    </form>
  </div>
</div>

<script>
function showAdminPopup(message, type = "success") {
  const popup = document.getElementById("adminPopup");
  const icon = document.getElementById("adminPopupIcon");
  const title = document.getElementById("adminPopupTitle");
  const text = document.getElementById("adminPopupText");

  const configs = {
    success: { icon: "‚úÖ", title: "Success", bg: "bg-green-100", text: "text-green-800", border: "border-green-200" },
    error: { icon: "‚ùå", title: "Error", bg: "bg-red-100", text: "text-red-800", border: "border-red-200" },
    info: { icon: "‚ÑπÔ∏è", title: "Info", bg: "bg-blue-100", text: "text-blue-800", border: "border-blue-200" }
  };

  const config = configs[type] || configs.info;
  
  icon.textContent = config.icon;
  icon.className = `w-8 h-8 rounded-lg flex items-center justify-center text-lg ${config.bg} ${config.border}`;
  title.textContent = config.title;
  title.className = `font-bold text-sm ${config.text}`;
  text.textContent = message;
  
  // Update popup border color
  popup.querySelector('div').className = `bg-white rounded-2xl shadow-2xl border ${config.border} p-4 flex items-center space-x-3 min-w-[280px]`;

  popup.classList.remove("hidden");
  setTimeout(() => {
    popup.classList.remove("translate-x-full");
    popup.classList.add("translate-x-0");
  }, 10);

  setTimeout(() => {
    popup.classList.add("translate-x-full");
    popup.classList.remove("translate-x-0");
    setTimeout(() => popup.classList.add("hidden"), 500);
  }, 4000);
}
</script>


  </main>

  <script>
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
      ? "https://iyonicweb.onrender.com" 
      : "https://iyonicweb.onrender.com/api/admin"; 

    document.addEventListener("DOMContentLoaded", () => {
      loadStats();
      loadUsers();
      loadPipeline();

      // Mobile menu toggle
      document.getElementById("toggleMenu").addEventListener("click", () => {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("hidden");
      });

      // Pipeline Form Submission
      document.getElementById("pipelineForm").addEventListener("submit", handlePipelineSubmit);
    });

    function showAdminSection(id) {
      document.querySelectorAll(".admin-section").forEach(sec => {
        sec.classList.add("hidden");
        sec.classList.add("opacity-0");
        sec.classList.add("translate-y-4");
      });
      
      const target = document.getElementById(id + "Section");
      target.classList.remove("hidden");
      
      setTimeout(() => {
        target.classList.remove("opacity-0");
        target.classList.remove("translate-y-4");
      }, 50);

      if (id === 'pipeline') loadPipeline();

      const sidebar = document.getElementById("sidebar");
      if (window.innerWidth < 768) {
        sidebar.classList.add("hidden");
      }
    }

    function filterByStatus(status) {
      const tiles = document.querySelectorAll("#pipelineTiles > div");
      tiles.forEach(tile => {
        const tileStatus = tile.querySelector("span.bg-blue-100").textContent;
        if (status === "All" || tileStatus === status) {
          tile.style.display = "block";
        } else {
          tile.style.display = "none";
        }
      });
    }

    // Pipeline Functions
    let pipelineData = [];

    async function updatePipelineStatus(id, newStatus) {
      event.stopPropagation();
      try {
        const res = await fetch(`${API_BASE}/pipeline/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: newStatus })
        });
        if (res.ok) {
          showAdminPopup("Status updated");
          loadPipeline();
        }
      } catch (err) {
        console.error("Status update error", err);
      }
    }

    async function loadPipeline() {
      try {
        const res = await fetch(`${API_BASE}/pipeline`);
        pipelineData = await res.json();
        renderPipelineBoard();
      } catch (err) {
        console.error("Pipeline load error", err);
      }
    }

    function renderPipelineBoard() {
      const statusFilters = document.getElementById("statusFilters");
      const pipelineTiles = document.getElementById("pipelineTiles");
      const statuses = ["All", "Lead", "Contacted", "Proposal", "In Progress", "Completed"];
      const statusIcons = {
        "All": "üìã",
        "Lead": "üéØ",
        "Contacted": "üìû",
        "Proposal": "üìÑ",
        "In Progress": "‚ö°",
        "Completed": "‚úÖ"
      };

      // Render status filter buttons
      statusFilters.innerHTML = "";
      statuses.forEach(status => {
        const count = status === "All" ? pipelineData.length : pipelineData.filter(item => item.status === status).length;
        const button = document.createElement("button");
        button.className = "flex items-center space-x-2 px-4 py-2 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-200";
        button.onclick = () => filterByStatus(status);
        button.innerHTML = `
          <span class="text-lg">${statusIcons[status]}</span>
          <span class="font-medium text-gray-700">${status}</span>
          <span class="bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full font-bold">${count}</span>
        `;
        statusFilters.appendChild(button);
      });

      // Render all pipeline tiles
      pipelineTiles.innerHTML = "";
      pipelineData.forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 cursor-pointer group";
        card.onclick = () => editPipelineItem(item._id);
        card.innerHTML = `
          <div class="mb-3">
            <div class="flex items-start justify-between mb-2">
              <h4 class="font-bold text-gray-800 text-sm leading-tight group-hover:text-blue-600 transition-colors">${item.businessName}</h4>
            </div>
            <div class="flex flex-wrap gap-2 mb-3">
              <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">${item.status}</span>
            </div>
          </div>
          <div class="space-y-2 mb-4">
            <div class="flex items-center text-gray-500 group-hover:text-gray-700 transition-colors">
              <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              <span class="text-xs font-medium truncate">${item.email || 'No email'}</span>
            </div>
            ${item.phone ? `
            <div class="flex items-center text-gray-500">
              <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
              <span class="text-xs font-medium">${item.phone}</span>
            </div>
            ` : ''}
            ${item.secondaryPhone || item.altContact ? `
            <div class="mt-2 pt-2 border-t border-gray-100 flex flex-col space-y-1">
              ${item.secondaryPhone ? `
              <div class="flex items-center text-xs text-gray-400 italic">
                <span class="font-bold uppercase mr-1 opacity-60">Alt:</span>
                ${item.secondaryPhone}
              </div>
              ` : ''}
              ${item.altContact ? `
              <div class="flex items-center text-xs text-gray-400 italic">
                <span class="font-bold uppercase mr-1 opacity-60">Who:</span>
                ${item.altContact}
              </div>
              ` : ''}
            </div>
            ` : ''}
            ${item.notes ? `
            <div class="mt-2 p-2 bg-gray-50 rounded-lg text-xs text-gray-500 font-medium line-clamp-2 italic">
              "${item.notes}"
            </div>
            ` : ''}
          </div>
          <div class="pt-3 border-t border-gray-100 flex items-center justify-between">
            <div class="flex items-center text-gray-400">
              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
              <span class="text-xs font-bold uppercase tracking-tight">${new Date(item.createdAt).toLocaleDateString()}</span>
            </div>
            <button onclick="event.stopPropagation(); deletePipelineItem('${item._id}')" class="w-6 h-6 flex items-center justify-center rounded-lg bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition-all duration-200">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        `;
        pipelineTiles.appendChild(card);
      });
    }

    function openPipelineModal(isEdit = false) {
      const modal = document.getElementById("pipelineModal");
      const modalContainer = document.getElementById("modalContainer");
      const title = document.getElementById("modalTitle");
      const form = document.getElementById("pipelineForm");
      
      if (!isEdit) {
        form.reset();
        document.getElementById("pipelineId").value = "";
        document.getElementById("status").value = "Lead";
        // Reset radio buttons to Lead
        const radio = document.querySelector('input[name="status-radio"][value="Lead"]');
        if (radio) radio.checked = true;
        title.textContent = "Add New Prospect";
      } else {
        title.textContent = "Edit Prospect";
      }
      
      modal.classList.remove("hidden");
      setTimeout(() => {
        modal.classList.remove("opacity-0");
        modalContainer.classList.remove("scale-95");
        modalContainer.classList.add("scale-100");
      }, 10);
    }

    function closePipelineModal() {
      const modal = document.getElementById("pipelineModal");
      const modalContainer = document.getElementById("modalContainer");
      
      modalContainer.classList.remove("scale-100");
      modalContainer.classList.add("scale-95");
      modal.classList.add("opacity-0");
      
      setTimeout(() => {
        modal.classList.add("hidden");
      }, 300);
    }

    async function handlePipelineSubmit(e) {
      e.preventDefault();
      const id = document.getElementById("pipelineId").value;
      const data = {
        businessName: document.getElementById("businessName").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        secondaryPhone: document.getElementById("secondaryPhone").value,
        altContact: document.getElementById("altContact").value,
        status: document.getElementById("status").value,
        notes: document.getElementById("notes").value,
      };

      try {
        const method = id ? "PUT" : "POST";
        const url = id ? `${API_BASE}/pipeline/${id}` : `${API_BASE}/pipeline`;
        
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          showAdminPopup(id ? "Prospect updated!" : "Prospect added!");
          closePipelineModal();
          loadPipeline();
        } else {
          showAdminPopup("Error saving prospect", "error");
        }
      } catch (err) {
        console.error("Pipeline submit error", err);
        showAdminPopup("Network error", "error");
      }
    }

    function editPipelineItem(id) {
      const item = pipelineData.find(i => i._id === id);
      if (!item) return;

      document.getElementById("pipelineId").value = item._id;
      document.getElementById("businessName").value = item.businessName;
      document.getElementById("email").value = item.email || "";
      document.getElementById("phone").value = item.phone || "";
      document.getElementById("secondaryPhone").value = item.secondaryPhone || "";
      document.getElementById("altContact").value = item.altContact || "";
      document.getElementById("status").value = item.status || "Lead";
      document.getElementById("notes").value = item.notes || "";

      // Update radio button
      const radio = document.querySelector(`input[name="status-radio"][value="${item.status}"]`);
      if (radio) radio.checked = true;

      openPipelineModal(true);
    }

    async function deletePipelineItem(id) {
      if (!confirm("Are you sure you want to delete this prospect?")) return;

      try {
        const res = await fetch(`${API_BASE}/pipeline/${id}`, { method: "DELETE" });
        if (res.ok) {
          showAdminPopup("Prospect deleted");
          loadPipeline();
        }
      } catch (err) {
        console.error("Delete error", err);
      }
    }


    function logout() {
      localStorage.removeItem("admin");
      window.location.href = "../adminlogin";
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/stats`);
        const data = await res.json();
        document.getElementById("totalUsers").textContent = data.totalUsers;
        document.getElementById("activeSites").textContent = data.activeSites;
        document.getElementById("totalRevenue").textContent = "$" + parseFloat(data.totalRevenue).toFixed(2);
      } catch (err) {
        console.error("Stats error", err);
      }
    }
    async function loadUsers() {
      try {
        const res = await fetch(`${API_BASE}/users-with-sites`);
        const users = await res.json();

        const container = document.getElementById("usersTable");
        container.innerHTML = "";

        users.forEach(user => {
          const userCard = document.createElement("div");
          userCard.className = "bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group user-card";
          userCard.setAttribute("data-name", (user.name || "").toLowerCase());
          userCard.setAttribute("data-email", (user.email || "").toLowerCase());

          const panelId = `panel-${user._id}`;
          const banBtnId = `banBtn-${user._id}`;

          userCard.innerHTML = `
            <div class="flex items-center justify-between mb-8">
              <div class="w-16 h-16 bg-slate-900 text-white rounded-[1.5rem] flex items-center justify-center font-black text-2xl shadow-lg shadow-slate-900/20 group-hover:scale-110 transition-transform">
                ${(user.name || user.email)[0].toUpperCase()}
              </div>
              <span class="px-4 py-1.5 rounded-full text-[10px] font-black tracking-widest uppercase ${user.banned ? 'bg-red-50 text-red-500' : 'bg-emerald-50 text-emerald-500'}">
                ${user.banned ? 'Banned' : 'Active'}
              </span>
            </div>
            
            <div class="flex-grow">
              <h4 class="text-xl font-black text-slate-900 leading-tight mb-1 group-hover:text-orange-600 transition-colors">${user.name || "Anonymous User"}</h4>
              <p class="text-sm text-gray-400 font-medium mb-1">${user.email}</p>
              <p class="text-xs text-slate-300 font-bold uppercase tracking-tighter">${user.phone || "No phone registered"}</p>
            </div>

            <div class="flex items-center space-x-3 mt-8 pt-8 border-t border-gray-50">
              <button id="${banBtnId}" onclick="toggleBan('${user.email}', ${!user.banned}, '${banBtnId}')"
                class="flex-1 py-4 text-xs font-black uppercase tracking-widest rounded-2xl transition-all ${
                  user.banned
                    ? 'bg-emerald-500 hover:bg-emerald-600 text-white shadow-lg shadow-emerald-500/20'
                    : 'bg-red-50 hover:bg-red-500 text-red-500 hover:text-white'
                }">
                ${user.banned ? "Unban" : "Ban"}
              </button>
              <button onclick="toggleUserPanel('${panelId}')"
                class="flex-1 py-4 text-xs font-black uppercase tracking-widest bg-slate-900 hover:bg-black text-white rounded-2xl transition-all shadow-lg shadow-slate-900/10 manage-btn">
                ${user.sites.length > 0 ? `Manage (${user.sites.length})` : "View"}
              </button>
            </div>

            <div id="${panelId}" class="hidden mt-6 pt-6 border-t border-gray-100 space-y-4">
              ${user.sites.length > 0 ? `
                <h5 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-4">Active Websites</h5>
                <div class="space-y-4">
                  ${user.sites.map((site, index) => {
                    const timerId = `countdown-${user._id}-${index}`;
                    const suspendBtnId = `suspendBtn-${site._id}`;
                    return `
                    <div class="p-5 rounded-3xl bg-slate-50 border border-gray-100 group/site">
                      <div class="flex justify-between items-start mb-4">
                        <div>
                          <p class="font-black text-slate-900 text-sm mb-0.5">${site.customName || site.siteName}</p>
                          <p class="text-[10px] text-slate-400 font-bold tracking-tight">${site.domain || "pending-domain.com"}</p>
                        </div>
                        <span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-wider ${
                          site.suspended ? "bg-amber-100 text-amber-600" :
                          site.status === "Active" ? "bg-emerald-100 text-emerald-600" : "bg-red-100 text-red-600"
                        }">${site.suspended ? "Suspended" : site.status}</span>
                      </div>
                      
                      <div class="flex items-center justify-between mt-6">
                        <div class="text-[10px]">
                          <span class="text-slate-300 font-bold uppercase tracking-widest block mb-1">Expires in:</span>
                          <span id="${timerId}" class="font-black text-slate-900 text-sm">...</span>
                        </div>
                        <button id="${suspendBtnId}" onclick="toggleSuspend('${site._id}', ${!site.suspended}, '${suspendBtnId}')"
                          class="text-[9px] font-black tracking-widest px-4 py-2 rounded-xl transition-all ${
                            site.suspended
                              ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20'
                              : 'bg-white text-red-500 border border-red-100 hover:bg-red-50'
                          }">
                          ${site.suspended ? "UNSUSPEND" : "SUSPEND"}
                        </button>
                      </div>
                    </div>
                    `;
                  }).join("")}
                </div>
              ` : `<p class="text-sm text-gray-400 font-medium italic text-center py-4">No active websites found.</p>`}
            </div>
          `;

          container.appendChild(userCard);

          user.sites.forEach((site, index) => {
            const elId = `countdown-${user._id}-${index}`;
            startExpiryTimer(elId, site.lastPaymentDate, site.planType || "monthly");
          });
        });

      } catch (err) {
        console.error("Users + Sites load error", err);
      }
    }

function toggleBan(email, ban, btnId) {
  const btn = document.getElementById(btnId);
  if (!btn) return;

  btn.disabled = true;
  btn.textContent = ban ? "Banning..." : "Unbanning...";

  fetch(`${API_BASE}/ban-user`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, banned: ban })
  })
    .then(res => res.json())
    .then(data => {
      showAdminPopup(data.message || "Ban status updated");
      loadUsers(); // refresh UI
    })
    .catch(err => {
      console.error("Toggle ban error:", err);
      showAdminPopup("‚ùå Failed to toggle ban.", "error");
      btn.disabled = false;
      btn.textContent = ban ? "Ban User" : "Unban User";
    });
}


function startExpiryTimer(elementId, lastPaymentDate, planType = "monthly") {
  const msPerPlan = {
    daily: 1 * 86400000,
    weekly: 7 * 86400000,
    monthly: 30 * 86400000
  };

  const el = document.getElementById(elementId);
  if (!el || !lastPaymentDate) return;

  const planMS = msPerPlan[planType] || msPerPlan["monthly"];
  const baseDate = new Date(lastPaymentDate).getTime();
  const targetDate = baseDate + planMS;

  function updateTimer() {
    const now = Date.now();
    const diff = targetDate - now;

    if (diff <= 0) {
      el.textContent = "Expired";
      clearInterval(timer);
      return;
    }

    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);

    el.textContent = `${days}d ${hours}h ${mins}m`;
  }

  updateTimer(); // call immediately
  const timer = setInterval(updateTimer, 60000);
}

    function filterUsers() {
      const query = document.getElementById("userSearchInput").value.toLowerCase().trim();
      const cards = document.querySelectorAll("#usersTable > div");

      cards.forEach(card => {
        const name = card.getAttribute("data-name") || "";
        const email = card.getAttribute("data-email") || "";
        const show = name.includes(query) || email.includes(query);
        card.style.display = show ? "block" : "none";
      });
    }
    function toggleUserPanel(id) {
  const panel = document.getElementById(id);
  if (panel) {
    panel.classList.toggle("hidden");
  }
}


  </script>
<script>
function toggleSuspend(subscriptionId, suspend, btnId) {
  const btn = document.getElementById(btnId);
  if (!btn) return;

  btn.disabled = true;
  btn.textContent = suspend ? "Suspending..." : "Unsuspending...";

  fetch(`${API_BASE}/toggle-suspend`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ subscriptionId, suspend })
  })
    .then(res => res.json())
    .then(data => {
      showAdminPopup(data.message || "Suspend status updated");
      loadUsers();
    })
    .catch(err => {
      console.error("Suspend toggle error:", err);
      showAdminPopup("‚ùå Failed to toggle suspend.", "error");
      btn.disabled = false;
      btn.textContent = suspend ? "Suspend" : "Unsuspend";
    });
}


  // ‚úÖ Redirect to login if not authenticated
  // (Moved to head)
  
</script>

</body>
</html>
